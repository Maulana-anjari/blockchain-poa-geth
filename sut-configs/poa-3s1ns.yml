# Auto-generated by scripts/generate-compose.sh for a PoA network.
services:
  # --- Bootnode (Non-Signer 1) ---
  nonsigner1:
    image: ethereum/client-go:alltools-v1.13.15
    container_name: nonsigner1
    hostname: nonsigner1
    volumes:
      - ./config/genesis.json:/config/genesis.json:ro
      - ./data/nonsigner1:/root/.ethereum
      - ./config/passwords/nonsigner1.pass:/root/password.txt:ro
      - ./data/nonsigner1/keystore:/root/.ethereum/keystore:ro
    ports:
      - "${BASE_GETH_P2P_PORT}:30303/tcp"
      - "${BASE_GETH_P2P_PORT}:30303/udp"
      - "${BASE_GETH_HTTP_PORT}:8545"
      - "${BASE_GETH_WS_PORT}:8546"
    command: >
      geth
      --nodekey /root/.ethereum/geth/nodekey
      --datadir /root/.ethereum --keystore /root/.ethereum/keystore
      --networkid "${NETWORK_ID}" --syncmode full --gcmode archive
      --port ${BASE_GETH_P2P_PORT}
      --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,clique,admin,personal" --http.corsdomain "*" --http.vhosts "*"
      --ws --ws.addr "0.0.0.0" --ws.port 8546 --ws.api "eth,net,web3,clique,admin,personal" --ws.origins "*"
      --metrics --metrics.expensive --metrics.influxdb
      --metrics.influxdb.endpoint "http://influxdb:8086"
      --metrics.influxdb.database "${INFLUXDB_DB}"
      --metrics.influxdb.username "${INFLUXDB_USER}"
      --metrics.influxdb.password "${INFLUXDB_PASSWORD}"
      --ethstats "nonsigner1:${ETHSTATS_WS_SECRET}@ethstats-server:3000"
      --password /root/password.txt --allow-insecure-unlock
    networks:
      - geth-network
    restart: unless-stopped

  # --- Signer Node 1 ---
  clef1:
    build:
      context: .
      dockerfile: Dockerfile.clef
    container_name: clef1
    environment:
      - CLEF_MASTER_PASSWORD=pass_signer_1
      - NETWORK_ID=477748
    volumes:
      - ./data/signer1/keystore:/root/.ethereum/keystore:ro
      - ./data/clef1:/root/.clef
      - ./config/rules.js:/root/rules.js:ro
    command: /usr/local/bin/start-clef.sh
    networks:
      - geth-network
    restart: unless-stopped

  signer1:
    image: ethereum/client-go:alltools-v1.13.15
    container_name: signer1
    depends_on:
      clef1:
        condition: service_started
      nonsigner1:
        condition: service_started
    volumes:
      - ./config/genesis.json:/config/genesis.json:ro
      - ./data/signer1:/root/.ethereum
    ports:
      - "8557:8545"
      - "8558:8546"
    command: >
      geth 
        --datadir /root/.ethereum 
        --networkid 477748 
        --syncmode full 
        --port 30304 
        --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,clique,admin" --http.corsdomain "*" --http.vhosts "*" 
        --ws --ws.addr "0.0.0.0" --ws.port 8546 --ws.api "eth,net,web3,clique,admin" --ws.origins "*" 
        --metrics --metrics.expensive --metrics.influxdb 
        --metrics.influxdb.endpoint "http://influxdb:8086" 
        --metrics.influxdb.database "${INFLUXDB_DB}" 
        --metrics.influxdb.username "${INFLUXDB_USER}" 
        --metrics.influxdb.password "${INFLUXDB_PASSWORD}" 
        --ethstats "signer1:${ETHSTATS_WS_SECRET}@ethstats-server:3000" 
        --bootnodes "${BOOTNODE_ENODE}" 
        --signer "http://clef1:8550" 
        --mine --miner.etherbase "${SIGNER1_ADDRESS}"
    networks:
      - geth-network
    restart: unless-stopped

  # --- Signer Node 2 ---
  clef2:
    build:
      context: .
      dockerfile: Dockerfile.clef
    container_name: clef2
    environment:
      - CLEF_MASTER_PASSWORD=pass_signer_2
      - NETWORK_ID=477748
    volumes:
      - ./data/signer2/keystore:/root/.ethereum/keystore:ro
      - ./data/clef2:/root/.clef
      - ./config/rules.js:/root/rules.js:ro
    command: /usr/local/bin/start-clef.sh
    networks:
      - geth-network
    restart: unless-stopped

  signer2:
    image: ethereum/client-go:alltools-v1.13.15
    container_name: signer2
    depends_on:
      clef2:
        condition: service_started
      nonsigner1:
        condition: service_started
    volumes:
      - ./config/genesis.json:/config/genesis.json:ro
      - ./data/signer2:/root/.ethereum
    ports:
      - "8559:8545"
      - "8560:8546"
    command: >
      geth 
        --datadir /root/.ethereum 
        --networkid 477748 
        --syncmode full 
        --port 30305 
        --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,clique,admin" --http.corsdomain "*" --http.vhosts "*" 
        --ws --ws.addr "0.0.0.0" --ws.port 8546 --ws.api "eth,net,web3,clique,admin" --ws.origins "*" 
        --metrics --metrics.expensive --metrics.influxdb 
        --metrics.influxdb.endpoint "http://influxdb:8086" 
        --metrics.influxdb.database "${INFLUXDB_DB}" 
        --metrics.influxdb.username "${INFLUXDB_USER}" 
        --metrics.influxdb.password "${INFLUXDB_PASSWORD}" 
        --ethstats "signer2:${ETHSTATS_WS_SECRET}@ethstats-server:3000" 
        --bootnodes "${BOOTNODE_ENODE}" 
        --signer "http://clef2:8550" 
        --mine --miner.etherbase "${SIGNER2_ADDRESS}"
    networks:
      - geth-network
    restart: unless-stopped

  # --- Signer Node 3 ---
  clef3:
    build:
      context: .
      dockerfile: Dockerfile.clef
    container_name: clef3
    environment:
      - CLEF_MASTER_PASSWORD=pass_signer_3
      - NETWORK_ID=477748
    volumes:
      - ./data/signer3/keystore:/root/.ethereum/keystore:ro
      - ./data/clef3:/root/.clef
      - ./config/rules.js:/root/rules.js:ro
    command: /usr/local/bin/start-clef.sh
    networks:
      - geth-network
    restart: unless-stopped

  signer3:
    image: ethereum/client-go:alltools-v1.13.15
    container_name: signer3
    depends_on:
      clef3:
        condition: service_started
      nonsigner1:
        condition: service_started
    volumes:
      - ./config/genesis.json:/config/genesis.json:ro
      - ./data/signer3:/root/.ethereum
    ports:
      - "8561:8545"
      - "8562:8546"
    command: >
      geth 
        --datadir /root/.ethereum 
        --networkid 477748 
        --syncmode full 
        --port 30306 
        --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,clique,admin" --http.corsdomain "*" --http.vhosts "*" 
        --ws --ws.addr "0.0.0.0" --ws.port 8546 --ws.api "eth,net,web3,clique,admin" --ws.origins "*" 
        --metrics --metrics.expensive --metrics.influxdb 
        --metrics.influxdb.endpoint "http://influxdb:8086" 
        --metrics.influxdb.database "${INFLUXDB_DB}" 
        --metrics.influxdb.username "${INFLUXDB_USER}" 
        --metrics.influxdb.password "${INFLUXDB_PASSWORD}" 
        --ethstats "signer3:${ETHSTATS_WS_SECRET}@ethstats-server:3000" 
        --bootnodes "${BOOTNODE_ENODE}" 
        --signer "http://clef3:8550" 
        --mine --miner.etherbase "${SIGNER3_ADDRESS}"
    networks:
      - geth-network
    restart: unless-stopped

# --- Monitoring Stack ---
  ethstats-server:
    # Builds the Ethstats server image directly from its GitHub repository.
    build:
      context: https://github.com/goerli/ethstats-server.git
    container_name: ethstats-server
    environment:
      WS_SECRET: "${ETHSTATS_WS_SECRET}"
    ports:
      - "${BASE_MONITORING_HTTP_PORT}:3000"
    networks:
      - geth-network
    restart: unless-stopped

  influxdb:
    image: influxdb:1.8
    container_name: influxdb
    volumes:
      # Use a named volume for persistent metrics data.
      - influxdb_data:/var/lib/influxdb
    environment:
      INFLUXDB_DB: "${INFLUXDB_DB}"
      INFLUXDB_ADMIN_USER: "${INFLUXDB_USER}"
      INFLUXDB_ADMIN_PASSWORD: "${INFLUXDB_PASSWORD}"
      INFLUXDB_HTTP_AUTH_ENABLED: "true"
      # These credentials are used by Geth to write data.
      INFLUXDB_USER: "${INFLUXDB_USER}"
      INFLUXDB_USER_PASSWORD: "${INFLUXDB_PASSWORD}"
    networks:
      - geth-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    depends_on: [influxdb]
    volumes:
      # Use a named volume for persistent dashboard configurations.
      - grafana_data:/var/lib/grafana
    ports:
      - "${BASE_GRAFANA_HTTP_PORT}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD}"
    networks:
      - geth-network
    restart: unless-stopped
  
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - geth-network
    restart: unless-stopped

  pushgateway:
    image: prom/pushgateway:latest
    container_name: pushgateway
    ports:
      - "9091:9091"
    networks:
      - geth-network
    restart: unless-stopped

# --- Network & Volume Definitions ---
networks:
  geth-network:
    name: ${COMPOSE_PROJECT_NAME}_net
    driver: bridge

volumes:
  grafana_data: {}
  influxdb_data: {}
